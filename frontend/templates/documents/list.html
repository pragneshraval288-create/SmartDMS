{% extends "base.html" %}
{% block title %}Documents - SmartDMS{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 mb-1">
      {% if active_folder %}
      {{ active_folder.name }}
      {% else %}
      All Documents
      {% endif %}
    </h1>

    <nav class="small text-muted">
      <a href="{{ url_for('document.list_documents') }}">Root</a>
      {% if active_folder %}
      / {{ active_folder.name }}
      {% endif %}
    </nav>
  </div>

  <div class="d-flex gap-2">
    <button class="btn btn-sm btn-danger" id="bulkDeleteBtn" disabled type="button" data-bs-toggle="modal"
      data-bs-target="#deleteModal" data-type="bulk">
      Delete Selected
    </button>

    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createFolderModal">
      + Folder
    </button>

    <a class="btn btn-sm btn-primary"
      href="{{ url_for('document.upload', folder=active_folder.id if active_folder else None) }}">
      Upload
    </a>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body p-0">
    <table class="table align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th width="40"><input type="checkbox" id="selectAll"></th>
          <th>Title</th>
          <th>Type</th>
          <th>Tags</th>
          <th>Uploaded</th>
          <th width="60" class="text-center">‚≠ê</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for item in items %}

        {% if item.type == "folder" %}
        {% set folder = item.obj %}
        <tr>
          <td>
            <input type="checkbox" class="selectItem" data-type="folder" value="{{ folder.id }}">
          </td>

          <td>
            <i class="bi bi-folder-fill text-primary me-2"></i>
            <a href="{{ url_for('document.list_documents', folder=folder.id) }}">
              {{ folder.name }}
            </a>
          </td>

          <td class="text-muted">Folder</td>
          <td>-</td>
          <td>{{ folder.created_at.strftime('%Y-%m-%d') }}</td>

          <td class="text-center">
            <button class="btn btn-sm btn-link p-0 favorite-toggle" data-type="folder" data-id="{{ folder.id }}">
              <i
                class="bi {% if folder.favorited_by|length > 0 %}bi-star-fill text-warning{% else %}bi-star{% endif %}"></i>
            </button>
          </td>

          <td class="text-end">
            <div class="dropdown">
              <button class="btn btn-sm btn-light" data-bs-toggle="dropdown">&#x22EE;</button>

              <ul class="dropdown-menu dropdown-menu-end" data-bs-auto-close="outside">
                <li><a class="dropdown-item" href="{{ url_for('document.list_documents', folder=folder.id) }}">Open</a>
                </li>
                <li><button class="dropdown-item" data-folder-id="{{ folder.id }}"
                    data-folder-action="copy">Copy</button></li>
                <li><button class="dropdown-item" data-folder-id="{{ folder.id }}"
                    data-folder-action="move">Move</button></li>
                <li><button class="dropdown-item" data-folder-id="{{ folder.id }}" data-folder-action="paste">Paste
                    here</button></li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li>
                  <button class="dropdown-item" data-folder-id="{{ folder.id }}" data-folder-name="{{ folder.name }}"
                    data-folder-action="rename">
                    Rename
                  </button>
                </li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li>
                  <button type="button" class="dropdown-item text-danger" data-bs-toggle="modal"
                    data-bs-target="#deleteModal" data-type="folder" data-id="{{ folder.id }}"
                    data-name="{{ folder.name }}">
                    Delete
                  </button>
                </li>
              </ul>
            </div>
          </td>
        </tr>
        {% endif %}

        {% if item.type == "document" %}
        {% set doc = item.obj %}
        <tr>
          <td>
            <input type="checkbox" class="selectItem" data-type="document" value="{{ doc.id }}">
          </td>

          <td>
            <i class="bi bi-file-earmark-text me-2 text-secondary"></i>
            <a href="{{ url_for('document.detail', document_id=doc.id) }}">
              {{ doc.title }}
            </a>
          </td>

          <td>{{ doc.file_type|upper if doc.file_type else '-' }}</td>
          <td>{{ doc.tags or '-' }}</td>
          <td>{{ doc.created_at.strftime('%Y-%m-%d') }}</td>

          <td class="text-center">
            <button class="btn btn-sm btn-link p-0 favorite-toggle" data-type="document" data-id="{{ doc.id }}">
              <i
                class="bi {% if doc.favorited_by|length > 0 %}bi-star-fill text-warning{% else %}bi-star{% endif %}"></i>
            </button>
          </td>

          <td class="text-end">
            <div class="dropdown">
              <button class="btn btn-sm btn-light" data-bs-toggle="dropdown">&#x22EE;</button>

              <ul class="dropdown-menu dropdown-menu-end">
                {% if doc.file_type in ['pdf','png','jpg','jpeg'] %}
                <li><a class="dropdown-item" target="_blank"
                    href="{{ url_for('document.preview', document_id=doc.id) }}">Preview</a></li>
                {% endif %}
                <li><a class="dropdown-item" href="{{ url_for('document.download', document_id=doc.id) }}">Download</a>
                </li>
                <li><a class="dropdown-item" href="{{ url_for('document.detail', document_id=doc.id) }}">Edit</a></li>
                <li><a class="dropdown-item" href="{{ url_for('document.detail', document_id=doc.id) }}#share">Share</a>
                </li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li><button class="dropdown-item" data-doc-id="{{ doc.id }}" data-doc-action="copy">Copy</button></li>
                <li><button class="dropdown-item" data-doc-id="{{ doc.id }}" data-doc-action="move">Move</button></li>
                <li><button class="dropdown-item" data-doc-id="{{ doc.id }}" data-doc-action="paste">Paste here</button>
                </li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li><button class="dropdown-item text-warning" data-doc-id="{{ doc.id }}"
                    data-doc-action="archive">Archive</button></li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li>
                  <button class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#deleteModal"
                    data-type="document" data-id="{{ doc.id }}" data-name="{{ doc.title }}">
                    Delete
                  </button>
                </li>
              </ul>
            </div>
          </td>
        </tr>
        {% endif %}

        {% else %}
        <tr>
          <td colspan="7" class="text-center text-muted py-4">
            No folders or documents found.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- UPDATED CREATE FOLDER MODAL - Dashboard jaisa design -->
<div class="modal fade" id="createFolderModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form action="{{ url_for('document.create_folder') }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        {% if active_folder %}
        <input type="hidden" name="parent_id" value="{{ active_folder.id }}">
        {% endif %}
        <div class="modal-header">
          <h5 class="modal-title">Create Folder</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" name="name" class="form-control" placeholder="Folder name" required>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary w-100">Create</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold">Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p class="mb-3">Select how you want to delete <strong id="deleteItemName">this item</strong>.</p>

        <input type="hidden" id="modalActionType" value="">
        <input type="hidden" id="modalItemId" value="">
        <input type="hidden" id="modalItemType" value="">

        <input type="hidden" id="csrfToken" value="{{ csrf_token() }}">

        <div class="d-flex justify-content-end gap-2 mt-4">
          <button type="button" class="btn btn-warning text-dark" id="btnSoftDelete">
            Move to Recycle Bin
          </button>

          <button type="button" class="btn btn-danger" id="btnHardDelete">
            Permanently Delete
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {

    // --- 1. Select All Logic ---
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.selectItem');
    const bulkBtn = document.getElementById('bulkDeleteBtn');

    function toggleBulkBtn() {
      const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
      bulkBtn.disabled = !anyChecked;
    }

    if (selectAll) {
      selectAll.addEventListener('change', function () {
        checkboxes.forEach(cb => cb.checked = this.checked);
        toggleBulkBtn();
      });
    }

    checkboxes.forEach(cb => {
      cb.addEventListener('change', toggleBulkBtn);
    });

    // --- 2. Delete Modal Setup ---
    const deleteModal = document.getElementById('deleteModal');
    const nameSpan = document.getElementById('deleteItemName');
    const inputActionType = document.getElementById('modalActionType');
    const inputItemId = document.getElementById('modalItemId');
    const inputItemType = document.getElementById('modalItemType');
    const csrfToken = document.getElementById('csrfToken').value;

    if (deleteModal) {
      deleteModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const type = button.getAttribute('data-type');

        if (type === 'bulk') {
          nameSpan.textContent = "the selected items";
          inputActionType.value = 'bulk';
        } else {
          const id = button.getAttribute('data-id');
          const name = button.getAttribute('data-name');
          nameSpan.textContent = name ? `"${name}"` : 'this item';

          inputActionType.value = 'single';
          inputItemId.value = id;
          inputItemType.value = type;
        }
      });
    }

    // --- 3. Handle Delete Actions (Fixed Error Handling) ---
    function performDelete(deleteMode) {
      const actionType = inputActionType.value;
      let requests = [];

      if (actionType === 'single') {
        const id = inputItemId.value;
        const type = inputItemType.value;

        let url = '';
        if (type === 'document') {
          url = deleteMode === 'soft' ? `/documents/${id}/bin` : `/documents/${id}/delete`;
        } else if (type === 'folder') {
          url = deleteMode === 'soft' ? `/documents/folders/${id}/bin` : `/documents/folders/${id}/delete`;
        }

        requests.push(fetch(url, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrfToken }
        }));

      } else if (actionType === 'bulk') {
        const folderIds = Array.from(document.querySelectorAll('.selectItem[data-type="folder"]:checked')).map(cb => cb.value);
        const docIds = Array.from(document.querySelectorAll('.selectItem[data-type="document"]:checked')).map(cb => cb.value);

        if (folderIds.length > 0) {
          const url = deleteMode === 'soft' ? '/documents/folders/bulk/bin' : '/documents/folders/bulk/delete';
          requests.push(fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ ids: folderIds })
          }));
        }

        if (docIds.length > 0) {
          const url = deleteMode === 'soft' ? '/documents/bulk/bin' : '/documents/bulk/delete';
          requests.push(fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ ids: docIds })
          }));
        }
      }

      // --- Process Responses and Show REAL Errors ---
      Promise.all(requests)
        .then(responses => Promise.all(responses.map(r => r.json())))
        .then(results => {
          // Find any failed request
          const failure = results.find(res => !res.success);

          if (!failure) {
            location.reload(); // Success!
          } else {
            // Alert the specific error message from backend
            alert("Error: " + (failure.error || "An unknown error occurred."));
            // Optional: reload anyway to reflect state
            // location.reload();
          }
        })
        .catch(err => {
          console.error(err);
          alert("A network error occurred.");
        });
    }

    document.getElementById('btnSoftDelete').addEventListener('click', () => performDelete('soft'));
    document.getElementById('btnHardDelete').addEventListener('click', () => {
      if (confirm("Permanently delete? This action cannot be undone.")) performDelete('hard');
    });

    // --- 4. Rename Logic ---
    document.querySelectorAll('[data-folder-action="rename"]').forEach(btn => {
      btn.addEventListener('click', function () {
        const id = this.dataset.folderId;
        const currentName = this.dataset.folderName || "";
        const newName = prompt("Enter new folder name:", currentName);

        if (newName && newName !== currentName) {
          fetch(`/documents/folders/${id}/rename`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ name: newName })
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) location.reload();
              else alert("Rename failed: " + (data.error || "Unknown error"));
            })
            .catch(err => alert("Network error"));
        }
      });
    });

    // --- 5. Archive Logic ---
    document.querySelectorAll('[data-doc-action="archive"]').forEach(btn => {
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        const id = this.dataset.docId;
        if (!confirm("Archive this document?")) return;

        fetch(`/documents/${id}/archive`, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrfToken }
        })
          .then(res => res.json())
          .then(data => {
            if (data.success) location.reload();
            else alert("Archive failed: " + (data.error || "Unknown error"));
          });
      });
    });
  });
</script>
{% endblock %}`